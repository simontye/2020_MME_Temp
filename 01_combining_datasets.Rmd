---
title: "Combining Datasets"
author: "Simon Tye"
date: "3/20/2020"
output: github_document
---

### Status
This document combines Wisconsin and Minnesota fishkill data from Till et al. (2019) and Phelps et al. (2019) datasets. The Till et al. dataset had fishkill events associated with unique waterbody identifiers (using WBIC) and the Phelps dataset had GPS coordinates for each waterbody. I used these data to associate each waterbody with the same identifier (site_id), which can be used for comparisons with water temperature data in Winslow et al. (2017). The combined dataset includes all fishkill events from Till et al. (2019) and 240/284 fishkill events from Phelps et al. (2019).

### Files in data/raw:
- `MN_Fish_Final.csv`: Minnesota fishkill data from Phelps et al. (2019)
- `MN_Site_County.csv`: List of waterbodies in Minnesota from the Minnesota Department of Natural Resources
- `WI_Fish_Final.csv`: Wisconsin fishkill data from Till et al. (2019)
- `WI_Site.csv`: List of waterbodies in Wisconsin from the Wisconsin Department of Natural Resources
- `Site_ID`: Attributes of waterbodies in Minnesota from the Minnesota Department of Natural Resources
- `thermal.csv`: Historical thermal data for upper midwest lakes (1980 to 2013) from Winslow et al. (2017)

```{R: Load packages}
# Install packages
#install.packages(c("plyr", "remotes", "data.table", "tidyverse", "rworldmap",
#                   "rworldxtra", "sp", "rgeos", "sf", "counties", "usmap", "ggmap", "ggrepel", "ggspatial",
#                   "rgdal", "lubridate", "raster", "naniar", "compareDF"))
#remotes::install_github("USGS-R/lakeattributes")

# Load packages
library(plyr)
library(remotes)
library(lakeattributes)
library(data.table)
library(tidyverse)
#library(rworldmap)
#library(rworldxtra)
library(sp)
library(rgeos)
library(sf)
#library(usmap)
#library(ggmap)
#library(ggrepel)
library(ggspatial)
library(rgdal)
library(lubridate)
library(raster)
library(naniar)
library(compareDF)
```

```{R: Load data}
# Reset global environment
rm(list=ls())

# Set working directory
setwd("/Users/simontye/Documents/Research/Projects/MME_Temp/2020_MME_Temp")

# Load files
MN.Fish  <- read.csv(file = "data/raw/MN_Fish_Final.csv", head = TRUE, sep = ",")
MN.Site  <- read.csv(file = "data/raw/MN_Site_County.csv", head = TRUE, sep = ",")
WI.Fish  <- read.csv(file = "data/raw/WI_Fish_Final.csv", head = TRUE, sep = ",")
WI.Site  <- read.csv(file = "data/raw/WI_Site.csv", head = TRUE, sep = ",")
Site.ID  <- read.csv(file = "data/raw/Site_ID.csv", head = TRUE, sep = ",")
thermal  <- read.csv(file = "data/raw/thermal_metrics.csv")
thermal  <- inner_join(thermal, Site.ID, by = "site_id")
```

### Step 1: Minnesota fishkills

This matches the GPS coordinates from each fishkill event from Phelps et al. (2019) with the centroid of the nearest waterbody. This allows for the association of each event with waterbody identifiers and thermal metrics.

```{R: Minnesota}
# Subset event number and coordinates from MN.Fish data
MN.Fish.GPS <- MN.Fish[, c(1, 70:71)]
MN.Fish.GPS$Lat <- as.numeric(as.character(MN.Fish.GPS$Lat))

# Subset events with coordinates (240 /284 events)
MN.Fish.GPS.1 <- na.omit(MN.Fish.GPS)

# Create list of events without coordinates to manually verify (44 events)
MN.Fish.Comp <- compare_df(MN.Fish.GPS, MN.Fish.GPS.1, c("Event"))
MN.Fish.Comp <- MN.Fish.Comp$comparison_df[1]
MN.Fish.Comp <- inner_join(x = MN.Fish.Comp, y = MN.Fish, by = "Event")

# Save event order for later
MN.Fish.Events <- MN.Fish.GPS.1[, 1]

# Create spatial points
MN.Fish.SP  <- SpatialPoints(MN.Fish.GPS.1[, 2:3])
MN.Site.SP  <- SpatialPoints(Site.ID[, 9:10])

# Find nearest lake centroid for each event based on Phelps' GPS coordinates
MN.Nearest <- apply(gDistance(MN.Fish.SP, MN.Site.SP, byid = TRUE), 2, which.min)

# Add event number and nearest site_id data
MN.Fish.GPS.1$Event <- as.vector(MN.Fish.Events)
MN.Fish.GPS.1$Site  <- as.vector(MN.Nearest)

# Merge fishkill event locations and estimated site_id locations
MN.Fish.1 <- merge(MN.Fish.GPS.1, Site.ID, by = "Site", all.x = TRUE, all.y = TRUE)
MN.Fish.1 <- subset(MN.Fish.1, !is.na(MN.Fish.1$Event))

# Create final MN database
MN.Fish.Final <- merge(MN.Fish.1, MN.Fish, by = "Event", all.x = TRUE, all.y = TRUE)
MN.Fish.Final <- subset(MN.Fish.Final, !is.na(MN.Fish.Final$Site))

# Change site_id column to match Till workflow
MN.Fish.Final$Station.Name <- MN.Fish.Final$GNIS_Nm

# Rename columns to match WI data
colnames(MN.Fish.Final)[c(12:13)] <- c("Lat", "Long")

# Save original (OG) GPS points, in case we want those laterr
colnames(MN.Fish.Final)[c(82:83)] <- c("Lat_OG", "Long_OG")
MN.Fish.Final$Lat_OG <- as.numeric(as.character(MN.Fish.Final$Lat_OG))

# Remove unnecessary columns
MN.Fish.Final[,c("Site", "Lat.x", "Long.x", "Prmnn_I",
                 "GNIS_ID", "GNIS_Nm", "ReachCd",
                 "FType", "FCode", "WBIC", "GPS", "Notes")] <- NULL

# Remove unnecessary dataframes
rm(MN.Fish, MN.Fish.1, MN.Fish.Comp,
   MN.Fish.GPS, MN.Fish.GPS.1,
   MN.Fish.SP, MN.Site, MN.Site.SP,
   MN.Fish.Events, MN.Nearest)
```

### Step 2: Wisconsin fishkills

This matches waterbody identifiers (WBIC) from Till et al. (2019) with waterbody information from the Wisconsin Department of Natural Resources. This allows for the association of both Minnesota and Wisconsin fishill events by the same waterbody identifier (site_id).

```{R: Wisconsin}
# Merge WI site data and NHD information
WI.Fish.1 <- merge(WI.Site, Site.ID, by = "site_id", all.x = FALSE, all.y = TRUE)

# Merge WI site data and Till et al. (2019) dataset
WI.Fish.2 <- merge(WI.Fish.1, WI.Fish, by = "WBIC", all.x = FALSE, all.y = TRUE)

# Remove sites without data (none removed)
WI.Fish.Final <- subset(WI.Fish.2, !is.na(WI.Fish.2$Event))

# Remove unnecessary columns
WI.Fish.Final[,c("WBIC", "X", "Site", "Prmnn_I", "GNIS_ID",
                 "GNIS_Nm", "ReachCd", "FType", "FCode",
                 "Snail", "Crayfish", "Frogs")] <- NULL

# Remove unnecessary dataframes
rm(WI.Fish, WI.Fish.1, WI.Fish.2, WI.Site, Site.ID)
```

### Step 3: Merge datasets and create 

This merges the Minnesota and Wisconsin datasets, fixes some formatting issues, and orders the events by date.

```{R: Merge datasets}
# Merge datasets
Fish.Final <- merge(MN.Fish.Final, WI.Fish.Final, all.x = TRUE, all.y = TRUE)

# Remove unnecessary columns
Fish.Final[,c("Site.Seq.No", "Swims.Station.Id", "Stream.Miles.or.Lake.Acres.Affected",
              "Snail", "Crayfish", "Frogs", "Event")] <- NULL

# Remove unnecessary dataframes
rm(MN.Fish.Final, WI.Fish.Final)

# Order events by date and add sequence of events to remove duplicate events in Step 6
Fish.Final <- Fish.Final[order(as.Date(Fish.Final$Investigation.Start.Date, format="%d-%b-%y")),]
Fish.Final$Fishkill.Inv.Seq.No <- c(1:871)
```

### Step 4: Group species observations by family

Manually reformatted common names across datasets, then grouped species observations by family.

```{R: Taxonomic organization}
# Create columns for fish families
Fish.Final$Acipenseridae  <- ifelse(Fish.Final$Sturgeon == 1, 1, 0)

Fish.Final$Amiidae        <- ifelse(Fish.Final$Bowfin == 1, 1,
                               ifelse(Fish.Final$Dogfish == 1, 1, 0))

Fish.Final$Catostomidae   <- ifelse(Fish.Final$Bigmouth.Buffalo == 1, 1,
                               ifelse(Fish.Final$Shorthead.Redhorse == 1, 1,
                                      ifelse(Fish.Final$Suckerfish == 1, 1,
                                             ifelse(Fish.Final$White.Sucker == 1, 1, 0))))

Fish.Final$Centrarchidae  <- ifelse(Fish.Final$Bass == 1, 1,
                               ifelse(Fish.Final$Bluegill == 1, 1,
                                      ifelse(Fish.Final$Crappie == 1, 1,
                                             ifelse(Fish.Final$Largemouth.Bass == 1, 1,
                                                    ifelse(Fish.Final$Pumpkinseed == 1, 1,
                                                           ifelse(Fish.Final$Rock.Bass == 1, 1,
                                                                  ifelse(Fish.Final$Smallmouth.Bass == 1, 1,
                                                                         ifelse(Fish.Final$Sunfish == 1, 1,
                                                                                ifelse(Fish.Final$Sunnies == 1, 1, 0)))))))))

Fish.Final$Clupeidae      <- ifelse(Fish.Final$Gizzard.Shad == 1, 1, 0)

Fish.Final$Cyprinidae     <- ifelse(Fish.Final$Carp == 1, 1,
                               ifelse(Fish.Final$Chub == 1, 1,
                                      ifelse(Fish.Final$Dace == 1, 1,
                                             ifelse(Fish.Final$Golden.Shiner == 1, 1,
                                                    ifelse(Fish.Final$Minnow == 1, 1, 0)))))

Fish.Final$Esocidae       <- ifelse(Fish.Final$Muskies == 1, 1,
                               ifelse(Fish.Final$Northern.Pike == 1, 1,
                                      ifelse(Fish.Final$Pike == 1, 1, 0)))

Fish.Final$Gasterosteidae <- ifelse(Fish.Final$Stickleback == 1, 1, 0)

Fish.Final$Gobiidae       <- ifelse(Fish.Final$Round.Goby == 1, 1, 0)

Fish.Final$Ictaluridae    <- ifelse(Fish.Final$Bullhead == 1, 1,
                               ifelse(Fish.Final$Catfish == 1, 1,
                                      ifelse(Fish.Final$Channel.Catfish == 1, 1,
                                             ifelse(Fish.Final$Stonecat == 1, 1, 0))))

Fish.Final$Lepisosteidae  <- ifelse(Fish.Final$Gar == 1, 1, 0)

Fish.Final$Osmeridae      <- ifelse(Fish.Final$Rainbow.Smelt == 1, 1, 0)

Fish.Final$Percidae       <- ifelse(Fish.Final$Darter == 1, 1,
                               ifelse(Fish.Final$Perch == 1, 1,
                                      ifelse(Fish.Final$Sauger == 1, 1,
                                             ifelse(Fish.Final$Walleye == 1, 1,
                                                    ifelse(Fish.Final$Yellow.Perch == 1, 1, 0)))))

Fish.Final$Salmonidae     <- ifelse(Fish.Final$Brown.Trout == 1, 1,
                               ifelse(Fish.Final$Cisco == 1, 1,
                                      ifelse(Fish.Final$Trout == 1, 1,
                                             ifelse(Fish.Final$Whitefish == 1, 1, 0))))

Fish.Final$Sciaenidae     <- ifelse(Fish.Final$Drum == 1, 1,
                               ifelse(Fish.Final$Freshwater.Drum == 1, 1, 0))

# Export Fish.Final dataset
#write.csv(Fish.Final, "data/raw/Fish_Final.csv", row.names = TRUE)
```

### Step 5: Preliminary map of observations

Preliminary map of fishkill events across Minnesota and Wisconsin

```{R: Preliminary map}
# Subset data for a map
Fish.Map <- subset(Fish.Final, select = c(Lat, Long, Year, State))

# Remove events before 2000
Fish.Map$Year <- ifelse(Fish.Map$Year > 2000, Fish.Map$Year, NA)
Fish.Map <- na.omit(Fish.Map)

# Create new event column
Fish.Map$Event <- c(1:646)

# Rename columns to match ggplot functions
names(Fish.Map)[1] <- "lat"
names(Fish.Map)[2] <- "long"
names(Fish.Map)[4] <- "region"

# Remove event that is appears to be outside the study region
Fish.Map$Event <- ifelse(Fish.Map$Event == 586, NA, Fish.Map$Event)
Fish.Map <- na.omit(Fish.Map)

# Create state boundaries
states   <- map_data("state")
states   <- subset(states, region %in% c("minnesota", "wisconsin"))

# Create county boundaries
counties <- map_data("county")
counties <- subset(counties, region %in% c("minnesota", "wisconsin"))

# Preliminary map
ggplot(data = states, mapping = aes(x = long, y = lat, group = group)) + 
  coord_fixed(1.3) + 
  geom_polygon(data = counties, color = "darkgray", fill = "gray", size = 0.5, aes(x = long, y = lat, alpha = 0.1, group = group)) +
  geom_polygon(data = states, color = "black", fill = NA, size = 1) +
  stat_density2d(data = Fish.Map, aes(x = long, y = lat, fill = ..level.., alpha = ..level.., group = region), bins = 30, geom = "polygon") +
  geom_point(data = Fish.Map, color = "black", fill = "darkolivegreen3", size = 2, shape = 21, aes(x = long, y = lat, group = region)) +
  theme_nothing()
```
