---
title: "prepare models"
author: "fishkill friends"
date: "2020/11/10"
output: github_document
---

### Step 1: Load packages and data

This is a second pass at data processing to prepare data for model fitting.

```{r: Load packages and data}
# Load packages
library(tidyverse)
library(caret)

# Reset global environment
rm(list = ls())

# Change working directory
setwd("/Users/simontye/Documents/Research/Projects/MME_Temp/2020_MME_Temp/data/processed")

# Load historical data
df_historical <- read.csv(file = "df_historical.csv", head = TRUE, sep = ",")
```

### Step 2: Partition and scale data

This verifies formatting and partitions the data into training and testing sets, which are scaled to allow for coefficient comparison. This is the same workflow as Till et al. (2019) except that I switched the file conversion from tibble to dataframe because of parsing errors.

```{r: Partition and scale data}
# Verify formatting and recode summerkill
df_historical <- df_historical %>%
  mutate(site_id      = as.character(site_id),
         year         = as.character(year),
         month        = as.character(month),
         season       = as.character(season),
         summerkill   = as.character(summerkill),
         ice_duration = as.double(ice_duration)) %>%
  dplyr::select(., -c("anthropogenic", "infectious", "unknown", "winterkill",
                      "event", "gnis_nm", "population")) %>% # removed population for now because there are NAs, messes with the models, need to fix
  mutate(summerkill = fct_recode(summerkill,
                                 "neg" = "0",
                                 "pos" = "1"))
# Set seed
set.seed(666)

# Creates series of training partitions
in_training <- createDataPartition(df_historical$summerkill, p = .75, list = FALSE)

# Partition training data
training <- df_historical  %>%
  slice(in_training)

# Partition testing data
testing  <- df_historical %>%
  slice(-in_training)

# Scale data
pre_proc_values <- preProcess(training, method = c("center", "scale"))
training <- predict(pre_proc_values, training) %>%
  mutate(year = as.integer(year))
testing  <- predict(pre_proc_values, testing) %>%
  mutate(summerkill = factor(testing$summerkill, 
                             levels = c("pos", "neg"), 
                             ordered = TRUE),
         year = as.integer(year))

# Change working directory
setwd("/Users/simontye/Documents/Research/Projects/MME_Temp/2020_MME_Temp/data/models")

# Export data
write_csv(training, "training.csv")
write_csv(testing,  "testing.csv")

# Remove dataframes
rm(df_historical, in_training, pre_proc_values,
   testing, training)
```

######################################
Proceed to `03_fit_models.Rmd`
######################################
