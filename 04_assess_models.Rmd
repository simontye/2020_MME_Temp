---
title: "assess models"
author: "fishkill friends"
date: "2020/11/10"
output: github_document
---

### ### Error on Line ~150 ### ###

### Background

Candidate models are compared in terms of their coefficients to check for sensitivity of the coefficients to modeling choices, and their out-of-sample predictive performance, assessed using logloss and ROC-AUC. This is the same workflow as Till et al. (2019) except that I switched the file conversion from tibble to dataframe because of parsing errors.

### Step 1: Load packages and data

Description.

```{r: Load packages and data}
# Load packages
library(tidyverse)
library(caret)
library(glmnet)
library(Matrix)
library(e1071)
library(broom)
library(yardstick)
library(purrr)
library(data.table)

# Reset global environment
rm(list = ls())

# Set working directory
setwd("/Users/simontye/Documents/Research/Projects/MME_Temp/2020_MME_Temp/data/models")

# Load data
training <- read.csv(file = "training.csv", head = TRUE, sep = ",")
testing  <- read.csv(file = "testing.csv",  head = TRUE, sep = ",")

# Reformat training data
training <- training %>%
  mutate(year         = as.character(year),
         month        = as.character(month),
         season       = as.factor(season),
         summerkill   = as.factor(summerkill),
         lat          = as.numeric(lat),
         long         = as.numeric(long),
         population   = as.numeric(population),
         state        = as.factor(state),
         mean_surf_z  = as.numeric(mean_surf_z),
         water_pca    = as.numeric(water_pca),
         mean_air_z   = as.numeric(mean_air_z),
         air_pca      = as.numeric(air_pca))

# Reformat testing data
testing <- testing %>%
  mutate(year         = as.character(year),
         month        = as.character(month),
         season       = as.factor(season),
         summerkill   = as.factor(summerkill),
         lat          = as.numeric(lat),
         long         = as.numeric(long),
         population   = as.numeric(population),
         state        = as.factor(state),
         mean_surf_z  = as.numeric(mean_surf_z),
         water_pca    = as.numeric(water_pca),
         mean_air_z   = as.numeric(mean_air_z),
         air_pca      = as.numeric(air_pca))
```

### Step 2: Load models

```{r: Load models}
# Change working directory
setwd("/Users/simontye/Documents/Research/Projects/MME_Temp/2020_MME_Temp/data/models/assessment") 

## Load loads
#w1e    <- readRDS("logistic_w1e.rds")
#w1s    <- readRDS("logistic_w1s.rds")
#w1se   <- readRDS("logistic_w1se.rds")
#a1e    <- readRDS("logistic_a1e.rds")
#a1s    <- readRDS("logistic_a1s.rds")
#a1se   <- readRDS("logistic_a1se.rds")
#w2e    <- readRDS("logistic_w2e.rds")
#w2s    <- readRDS("logistic_w2s.rds")
#w2se   <- readRDS("logistic_w2se.rds")
#a2e    <- readRDS("logistic_a2e.rds")
#a2s    <- readRDS("logistic_a2s.rds")
#a2se   <- readRDS("logistic_a2se.rds")
#w1e.mn <- readRDS("logistic_w1e_mn.rds")
#w1e.wi <- readRDS("logistic_w1e_wi.rds")
#a1e.mn <- readRDS("logistic_a1e_mn.rds")
#a1e.wi <- readRDS("logistic_a1e_wi.rds")
#w2e.mn <- readRDS("logistic_w2e_mn.rds")
#w2e.wi <- readRDS("logistic_w2e_wi.rds")
#a2e.mn <- readRDS("logistic_a2e_mn.rds")
#a2e.wi <- readRDS("logistic_a2e_wi.rds")
#
## Summary of water models
#summary(w1e )
#summary(w1s )
#summary(w1se)
#summary(w2e ) ###
#summary(w2s )
#summary(w2se)
#
## Summary of air models
#summary(a1e )
#summary(a1s )
#summary(a1se)
#summary(a2e )
#summary(a2s )
#summary(a2se) ###
#
## Summary of state-specific models
#summary(w1e.mn) #
#summary(a1e.mn) #
#summary(w2e.mn) #
#summary(a2e.mn) #
#summary(w1e.wi)
#summary(a1e.wi)
#summary(w2e.wi) ###
#summary(a2e.wi)

# Save file names
model_names <- list.files()

### Method 1 (Original)
# Load models
all_models <- model_names %>%
  map(., ~read_rds(.))

#### Method 2
#all_models <- list.files(pattern = ".rds$") %>%
#  map(readRDS) %>% 
#  bind_rows()

#### Method 3 (working, I think)
#model_names = list.files(path = '.', pattern = '*.rds$')
#all_models = lapply(model_names, function (x) data.table(readRDS(x)))
##all_models = ldply(dat_list, data.frame)

# Black magic
all_models <- tibble(name = str_sub(str_extract(model_names, "^.*\\."),
                                    1, -2), model = all_models)

str(all_models)
```

### Step 3: Extract fitted values

Extract fitted values and append as new column.

```{r: Extract fitted values}
# Black magic
predict_route <- function(model, newdata) {
  if("train" %in% class(model)) {
    predict(model, newdata, type = "prob")$pos
  } else {predict(model, newdata, type = "response")}
}

# Black magic (see error below)
all_models <- all_models %>%
  mutate(fit_test = map(model, predict_route, newdata = testing))

### Error in UseMethod("mutate_") : 
###   no applicable method for 'mutate_' applied to an object of class "list"

# Calculate logloss and auc. This can be made more concise w/ map() (from Till)
auc <- rep(NA, nrow(all_models))
logloss <- auc
for (i in 1:nrow(all_models)) {
  a <- tibble(fit_test = all_models$fit_test[[i]],
              truth    = testing$summerkill)
  auc[i] <- roc_auc(a, truth, fit_test)$.estimate
  logloss[i] <- mn_log_loss(a, truth, fit_test)$.estimate
}

# Black magic
all_models %>%
  add_column(auc, logloss) %>%
  arrange(logloss, desc(auc))
```

### Step 4: Extract coefficients

Extract coefficients from each model.

```{r: Extract coefficients}
# Print model results
all_models$name

# Black magic
extract_coef <- function(model, name) {
  if ("train" %in% class(model)) {
    m <- model$finalModel %>%
      coef(model$bestTune$lambda)
    out <- tibble(term = row.names(m),
                  estimate = m[, 1]) %>%
      filter(term != "(Intercept)") %>%
      dplyr::select(term, estimate)
  }
  if ("glmerMod" %in% class(model)) {
    out <- model %>%
      tidy() %>%
      filter(group == "fixed") %>%
      filter(term != "(Intercept)") %>%
      filter(p.value <= .3) %>%
      dplyr::select(term, estimate)
  }
  if ("glm" %in% class(model)) {
    out <- model %>%
      tidy() %>%
      filter(term != "(Intercept)") %>%
      dplyr::select(term, estimate)
  }
  out
}

# Black magic
all_models <- all_models %>%
  mutate(coef = map2(model, name, extract_coef))

### Error: Problem with `mutate()` input `coef`.
### x No tidy method for objects of class glmerMod
### â„¹ Input `coef` is `map2(model, name, extract_coef)`.
### Run `rlang::last_error()` to see where the error occurred.
```

### Step 5: Plot coefficients

Plot coefficients.

```{r: Plot coefficients}
# Black magic
all_models %>%
  unnest(coef) %>%
  ggplot(aes(x = fct_reorder(term, estimate), 
             y = estimate, 
             fill = estimate > 0)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ name, ncol = 4) +
  coord_flip() +
  labs(x = NULL) +
  theme_bw()
```

######################################
Proceed to `05_fit_full_models.Rmd`
######################################
