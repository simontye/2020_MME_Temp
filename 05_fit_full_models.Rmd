---
title: "fit full models"
author: "fishkill friends"
date: "2021_03_04"
output: github_document
---

### Background

A subset of the models are refit using the full historical data set.

### Step 1: Load packages and daat

```{r: Load packages and data}
# Load packages
library(tidyverse)
library(rsample)
library(caret)
library(glmnet)
library(Matrix)
library(e1071)
library(pROC)
library(PRROC) 
library(glmnetUtils)
library(doParallel)
library(lme4)

# Reset global environment
rm(list = ls())

# Set working directory
setwd("/Users/simontye/Documents/Research/Projects/MME_Temp/2020_MME_Temp/data")

# Load historical data
df.historical <- read.csv(file = "processed/df_historical.csv", head = TRUE, sep = ",")

# Format historical dataset
df.historical <- df.historical %>%
  mutate(site_id      = as.factor(site_id),
         year         = as.character(year),
         month        = as.character(month),
         season       = as.factor(season),
         summerkill   = as.factor(summerkill),
         lat          = as.numeric(lat),
         long         = as.numeric(long),
         population   = as.numeric(population),
         state        = as.factor(state),
         mean_bot_z   = as.numeric(mean_bot_z),
         mean_surf_z  = as.numeric(mean_surf_z),
         water_pca    = as.numeric(water_pca),
         mean_air_z   = as.numeric(mean_air_z),
         air_pca      = as.numeric(air_pca)) %>%
    dplyr::select(., c("year", "month", "season",
                       "summerkill", "lat", "long",
                       "population", "state", "l1_code",
                       "max_surf", "mean_surf", "max_bot", "mean_bot",
                       "max_surf_z", "mean_surf_z", "max_bot_z", "mean_bot_z",
                       "max_air", "mean_air", "min_air",
                       "max_air_z", "mean_air_z", "min_air_z",
                       "air_pca", "water_pca",
                       "variance_after_ice_30", "variance_after_ice_60",
                       "log_schmidt", "ice_duration", "layer_diff",
                       "air_quad_temp", "water_quad_temp", "peak_temp",
                       "cumulative_above_0", "cumulative_above_5", "cumulative_above_10",
                       "site_id")) %>%
    mutate(summerkill = fct_recode(summerkill,
                                 "neg" = "0",
                                 "pos" = "1"))

# Scale data
pre.proc.values <- preProcess(df.historical, method = c("center", "scale"))
df.historical   <- predict(pre.proc.values, df.historical)
```

### Step 2: Fit full models

Specify predictor set and control parameters.

```{r: Fit full models}
# Simple air model
a1 <- summerkill ~ lat + long + season + population + state +
  mean_air_z + air_pca

# Simple water model
w1 <- summerkill ~ lat + long + season + population + state +
  mean_surf_z + water_pca

## No downsampling
#control.logloss <- trainControl(method = "repeatedcv",
#                                number = 5,
#                                repeats = 5,
#                                summaryFunction = mnLogLoss,
#                                classProbs = TRUE)

# Downsampling
control.logloss.ds <- trainControl(method = "repeatedcv",
                                   number = 5,
                                   repeats = 5,
                                   summaryFunction = mnLogLoss,
                                   classProbs = TRUE,
                                   sampling = "down")
```

### Step 3: Logistic models

```{r: Logistic model}
## Black magic
#full_logistic_f1_backwards <- glm(f1,
#                         historical_data,
#                         family = "binomial") 
## Black magic
#full_logistic_f1_backwards <- step(full_logistic_f1_backwards)
#
## Save model
#write_rds(full_logistic_f1_backwards, "../models/full_logistic_f1.rds")
```

### Step 4: Lasso models

```{r: Lasso model}
# For remote computing
#cl <- makePSOCKcluster(4)
#registerDoParallel(cl)

# Create grid of parameters
par_grid <-  expand.grid(alpha = 1, lambda = 10^seq(-3, -1, length = 10))

# Set seed
set.seed(825)

# Simple air model
full_lasso_a1_logloss_ds <- train(a1, 
                                  data      = df.historical, 
                                  method    = "glmnet", 
                                  metric    = "logLoss",
                                  tuneGrid  = par_grid,
                                  trControl = control.logloss.ds)
# Simple water model
full_lasso_w1_logloss_ds <- train(w1, 
                                  data      = df.historical, 
                                  method    = "glmnet", 
                                  metric    = "logLoss",
                                  tuneGrid  = par_grid,
                                  trControl = control.logloss.ds)
# For remote computing
#stopCluster(cl)

# Save models
write_rds(full_lasso_a1_logloss_ds, "models/full/full_lasso_a1_logloss_ds.rds")
write_rds(full_lasso_w1_logloss_ds, "models/full/full_lasso_w1_logloss_ds.rds")
```

### Step 5: Ridge models

```{r: Ridge model}
# For remote computing
#cl <- makePSOCKcluster(4)
#registerDoParallel(cl)

# Create grid of parameters
par_grid <- expand.grid(alpha = 0, lambda = 10^seq(-1.7, -1.3, length = 10))

# Set seed
set.seed(538)

# Simple air model
full_ridge_a1_logloss_ds <- train(a1, 
                                  data      = df.historical, 
                                  method    = "glmnet",
                                  metric    = "logLoss",
                                  tuneGrid  = par_grid,
                                  trControl = control.logloss.ds)

# Simple water model
full_ridge_w1_logloss_ds <- train(w1, 
                                  data      = df.historical, 
                                  method    = "glmnet",
                                  metric    = "logLoss",
                                  tuneGrid  = par_grid,
                                  trControl = control.logloss.ds)

# For remote computing
#stopCluster(cl)

# Save model
write_rds(full_ridge_a1_logloss_ds, "models/full/full_ridge_a1_logloss_ds.rds")
write_rds(full_ridge_w1_logloss_ds, "models/full/full_ridge_w1_logloss_ds.rds")
```

######################################
Proceed to `06_statistics.Rmd`
######################################

lasso_w1_logloss_ds
