---
title: "statistics"
author: "fishkill friends"
date: "2021_03_04"
output: github_document
---

### Background

Statistics

### Step 1: Load packages and data

```{r: Load packages and data}
# Load packages
library(ggplot2)
library(ggthemes)
library(ggmap)
library(gridExtra)
library(scales)
library(car)
library(DescTools)
library(spdep)
library(readr)
library(dplyr)
library(ggpubr)
library(rstatix)
library(reshape2)
library(maddog)

# Reset global environment
rm(list = ls())

# Change working directory
setwd("/Users/simontye/Documents/Research/Projects/MME_Temp/2020_MME_Temp")

# Load data
df.historical <- read_csv("data/processed/df_historical.csv")
df.future     <- read_csv("data/processed/df_future.csv")
df.snow       <- read_csv("data/processed/df_snow.csv")
```

### Step 2: Format data

```{r: Format data}
# Format historical data
fishkill.all <- df.historical %>%
  dplyr::mutate(fishkill = ifelse(anthropogenic == 1 | infectious == 1 | summerkill == 1 | winterkill == 1 | unknown == 1, 1, 0)) %>%
  dplyr::mutate(fishkill_cause = ifelse(anthropogenic == 1, "Anthropogenic",
                                        ifelse(infectious == 1, "Infectious",
                                               ifelse(summerkill == 1, "Summerkill",
                                                      ifelse(winterkill == 1, "Winterkill",
                                                             ifelse(unknown == 1, "Unknown", "Summer Non-event")))))) %>%
  dplyr::mutate(fishkill       = as.factor(fishkill),
                fishkill_cause = as.factor(fishkill_cause))

# Format summerkill data
fishkill.s <- df.historical %>%
  filter(month %in% c("6", "7", "8")) %>% # include sept? till did
  dplyr::mutate(fishkill = ifelse(anthropogenic == 1 | infectious == 1 | summerkill == 1 | winterkill == 1 | unknown == 1, 1, 0)) %>%
  dplyr::mutate(fishkill_cause = ifelse(anthropogenic == 1, "Anthropogenic",
                                        ifelse(infectious == 1, "Infectious",
                                               ifelse(summerkill == 1, "Summerkill",
                                                      ifelse(winterkill == 1, "Winterkill",
                                                             ifelse(unknown == 1, "Unknown", "Summer Non-event")))))) %>%
  dplyr::mutate(fishkill       = as.factor(fishkill),
                fishkill_cause = as.factor(fishkill_cause))

# Format winterkill data
# Winterkills
fishkill.w <- df.historical %>%
  filter(month %in% c("12", "1", "2")) %>% # include sept? till did
  dplyr::mutate(fishkill = ifelse(anthropogenic == 1 | infectious == 1 | summerkill == 1 | winterkill == 1 | unknown == 1, 1, 0)) %>%
  dplyr::mutate(fishkill_cause = ifelse(anthropogenic == 1, "Anthropogenic",
                                        ifelse(infectious == 1, "Infectious",
                                               ifelse(summerkill == 1, "Summerkill",
                                                      ifelse(winterkill == 1, "Winterkill",
                                                             ifelse(unknown == 1, "Unknown", "Winter Non-event")))))) %>%
  dplyr::mutate(fishkill       = as.factor(fishkill),
                fishkill_cause = as.factor(fishkill_cause))

# Format snow data
df.snow$month <- as.numeric(df.snow$month)
df.snow <- fishkill.w %>%   
  mutate(lat_round  = round(lat, 1),
         long_round = round(long, 1)) %>%
  inner_join(df.snow, by = c('year', 'month', 'lat_round', 'long_round')) %>%
  mutate(winterkill = ifelse(!is.na(fishkill_cause) & fishkill_cause == 'Winterkill', 1, 0))

# Format ice duration data
fishkill.i <- fishkill.all  %>%
  group_by(year, site_id) %>%
  summarise(ice_duration = mean(ice_duration), winterkill = max(winterkill))

# Create figure theme
pretty <- theme_classic(base_size = 12) +
  theme(#axis.title.y      = element_text(margin = margin(r = 20)),
        axis.title.x      = element_text(margin = margin(t = 20)), 
        axis.text         = element_text(color = "black"), 
        axis.ticks        = element_line(color = "black"),
        axis.ticks.length = unit(.25, "cm"), 
        legend.key.size   = unit(1.5,  'lines'),
        legend.position   = "right")
```

### Step 3: Summerkills (Dunnett's tests)

Dunnett's test to compare mean temperature estimates for fishkill events and non-events.

```{r: Dunnet's tests}
# Water
DunnettTest(mean_surf ~ factor(fishkill_cause), data = fishkill.s, control = 'Summer Non-event')

# Air
DunnettTest(mean_air ~ factor(fishkill_cause), data = fishkill.s, control = 'Summer Non-event')
```

```{r: Normal distributions}
# Summer non-event
control.lakes.w <- fishkill.s %>% 
  filter(fishkill_cause == 'Summer Non-event')
qqnorm(control.lakes.w$mean_surf)
qqnorm(control.lakes.a$mean_air)

# Summerkill
summerkill.lakes.w <- fishkill.s %>%
  filter(fishkill_cause == 'Summerkill')
qqnorm(summerkill.lakes.w$mean_surf)
qqnorm(summerkill.lakes.w$mean_air)

# Infectious
infectious.lakes.w <- fishkill.s %>%
  filter(fishkill_cause == 'Infectious')
qqnorm(infectious.lakes.w$mean_surf)
qqnorm(infectious.lakes.w$mean_air)

# Remove objects
rm(control.lakes.w, summerkill.lakes.w, infectious.lakes.w)
```

### Step 4: Summerkills and infectious (Welch's t-tests)

Welch's t-test for uneven variance between sample groups when comparing fishkill events and non-events.

```{r: T-tests}
# Summerkill
ttest.s.w <- t.test(mean_surf_z ~ summerkill, data = fishkill.s)
ttest.s.a <- t.test(mean_air ~ summerkill, data = fishkill.s)

# Infectious
ttest.i.w <- t.test(mean_surf_z ~ infectious, data = fishkill.s)
ttest.i.a <- t.test(mean_air ~ infectious, data = fishkill.s)
```

```{r: Normal distributions}
# Summer non-event
qq.control <- fishkill.s %>%
  filter(fishkill_cause == 'Summer Non-event')
qqnorm(qq.control$mean_surf)
qqnorm(qq.control$mean_air)

# Summerkill
qq.summerkill <- fishkill.s %>%
  filter(fishkill_cause == 'Summerkill')
qqplot(x = qq.control$mean_surf_z, y = qq.summerkill$mean_surf_z)
qqplot(x = qq.control$mean_air_z,  y = qq.summerkill$mean_air_z)

# Infectious
qq.infectious <- fishkill.s %>%
  filter(fishkill_cause == 'Infectious')
qqplot(x = qq.control$mean_surf_z, y = qq.infectious$mean_surf_z)
qqplot(x = qq.control$mean_air_z,  y = qq.infectious$mean_air_z)

# Remove objects
rm(qq.summerkill, qq.control, qq.infectious)
```

### Step 5: All fishkill causes and winterkills (ANOVAs, t-tests)

ANOVAS to compare fishkill causes and temperatures (winter)

```{r: ANOVA}
# ANOVA (surface water)
anova.w.s <- aov(mean_surf ~ factor(fishkill_cause), fishkill.w)
summary(anova.w.s)

# ANOVA (bottom water)
anova.w.b <- aov(mean_bot ~ factor(fishkill_cause), fishkill.w)
summary(anova.w)

# ANOVA (air)
anova.a <- aov(mean_air ~ factor(fishkill_cause), fishkill.w)
summary(anova.a)

# Tukey's test
tuk.a <- TukeyHSD(anova.a)
tuk.a

# ANOVA (snow)
anova.w.snow <- aov(snow ~ factor(fishkill_cause), df.snow)
summary(anova.w.snow)

# Tukey's test
tuk.snow <- TukeyHSD(anova.w.snow)
tuk.snow

# ANOVA (ice duration)
anova.w.i <- aov(ice_duration ~ winterkill, fishkill.i)
summary(anova.w.i)

# Remove objects
#rm(anova.w.s, anova.w.b, anova.a, tuk.a,
#   anova.w.snow, tuk.snow,
#   anova.w.i)
```

```{r: Normal distributions}
# Winter non-event
control.lakes.w <- fishkill.w %>% 
  filter(fishkill_cause == 'Winter Non-event')
qqnorm(control.lakes.w$mean_surf)
qqnorm(control.lakes.w$mean_air)

# Winterkill
winterkill.lakes.w <- fishkill.w %>%
  filter(fishkill_cause == 'Winterkill')
qqplot(x = control.lakes.w$mean_surf_z, y = winterkill.lakes.w$mean_surf_z)
qqplot(x = control.lakes.w$mean_air_z,  y = winterkill.lakes.w$mean_air_z)

# Ice duration
control.i    <- fishkill.i %>% filter(winterkill == 0)
winterkill.i <- fishkill.i %>% filter(winterkill == 1)
qqplot(control.i$ice_duration, winterkill.i$ice_duration)

# Remove objects
rm(control.lakes.w, winterkill.lakes.w,
   control.i, winterkill.i)
```

Welch's t-test due to unequal sample groups when comparing fishkill events and non-events

```{r: T-tests}
ttest.w.w <- t.test(mean_surf_z ~ winterkill, data = fishkill.w)
ttest.w.a <- t.test(mean_air_z ~ winterkill, data = fishkill.w)
```

One-sample t-test to see if the mean z-score is non-zero

```{r: T-tests}
# Subset winterkills
ttest.w.z <- filter(fishkill.all, fishkill_cause == 'Winterkill')

# Surface water
t.test(ttest.w.z$mean_surf_z, mu = 0)

# Bottom water
t.test(ttest.w.z$mean_bot_z, mu = 0)

# Air water
t.test(ttest.w.z$mean_air_z, mu = 0)
```

### Step 6: Moran's tests (need predictions_1)

```{r: Moran's tests}

fig3a_data <-df.historical %>%
  mutate(summerkill_binary = ifelse(is.na(summerkill) | summerkill == 'neg', 0 , 1)) %>%
  group_by(site_id) %>%
  summarise(MME = max(summerkill_binary), V1 = mean(long), V2 = mean(lat))

fig3b_data <- df.future %>%
  dplyr::select(site_id, lat, long, year) %>%
  bind_cols(predictions_1) %>%
  mutate(event = pos) %>%
  mutate(no_event_prob = 1 - event) %>%
  filter(year > 2030 & year < 2070) %>%
  group_by(site_id) %>%
  summarise(prob = (1 - prod(no_event_prob)), V1 = mean(long), V2 = mean(lat)) 

fig3c_data <- future_data %>%
  dplyr::select(wbic, lat, lon, year) %>%
  bind_cols(predictions_1)%>%
  mutate(event = pos) %>%
  mutate(no_event_prob = 1 - event) %>%
  filter(year > 2070) %>%
  group_by(wbic) %>%
  summarise(prob = (1 - prod(no_event_prob)), V1 = mean(lon), V2 = mean(lat)) 

coordinates(fig3a_data) <- c('V1', 'V2')
coordinates(fig3b_data) <- c('V1', 'V2')
coordinates(fig3c_data) <- c('V1', 'V2')

nb_p1 <- knn2nb(knearneigh(coordinates(coordinates(fig3a_data)),longlat = TRUE, k = 2))
nb_p2 <- knn2nb(knearneigh(coordinates(coordinates(fig3b_data)),longlat = TRUE, k = 2))
nb_p3 <- knn2nb(knearneigh(coordinates(coordinates(fig3c_data)),longlat = TRUE, k = 2))

weights_p1 <- nb2listw(nb_p1)
weights_p2 <- nb2listw(nb_p2)
weights_p3 <- nb2listw(nb_p3)

moran_MME   <- moran.test(fig3a_data$MME, weights_p1)
moran_Prob2 <- moran.test(fig3b_data$prob, weights_p2)
moran_Prob3 <- moran.test(fig3c_data$prob, weights_p3)

moran_MME
moran_Prob2
moran_Prob3
```

######################################
######################################
