---
title: "06_statistics"
author: "fishkill friends"
date: "2020/11/10"
output: github_document
---

### Background

XXX

### Step 1: Load packages and data

```{r: Load packages and data}
# Load packages
library(ggplot2)
library(ggthemes)
library(ggmap)
library(gridExtra)
library(scales)
library(car)
library(DescTools)
library(spdep)
library(readr)
library(dplyr)
library(ggpubr)
library(rstatix)

# Reset global environment
rm(list = ls())

# Change working directory
setwd("/Users/simontye/Documents/Research/Projects/MME_Temp/2020_MME_Temp/")

# Load data
df.historical <- read_csv('data/processed/df_historical.csv')
#df.future     <- read_csv('data/processed/df_future.csv')
#df.snow       <- read_csv('data/processed/df_snow.csv') 

#snow_data$month <- tolower(month.abb[as.numeric(snow_data$Month)])
#snow_data$year  <- snow_data$Year
```

### Step 2: Summary statistics

```{r: Fishkill counts}
# Count number of fishkills across states
df.historical %>%
  count(.$anthropogenic + .$infectious + .$summerkill + .$winterkill + .$unknown)

# Count number of fishkills in MN
df.historical %>%
  subset(., state == "minnesota") %>%
  count(.$anthropogenic + .$infectious + .$summerkill + .$winterkill + .$unknown)

# Count number of fishkills in WI
df.historical %>%
  subset(., state == "wisconsin") %>%
  count(.$anthropogenic + .$infectious + .$summerkill + .$winterkill + .$unknown)

# Count number of unique lakes (site_id) with fishkills
df.historical %>%
  subset(., anthropogenic >= 1 | infectious >= 1 | summerkill >= 1 | winterkill >= 1 | unknown >= 1) %>%
  group_by(site_id) %>%
  summarize(count = n())

##########################

# Count number of anthropogenic fishkills
df.historical %>%
  count(.$anthropogenic)

# Count number of infectious fishkills
df.historical %>%
  count(.$infectious)

# Count number of summerkills
df.historical %>%
  count(.$summerkill)

# Count number of winterkills
df.historical %>%
  count(.$winterkill)

# Count number of unknown fishkills
df.historical %>%
  count(.$unknown)

# Count number of unique lakes (site_id) with summerkills
df.historical %>%
  subset(., summerkill >= 1) %>%
  group_by(site_id) %>%
  summarize(count = n())
```

```{r: Summerkills}
# Create summerkills dataframe
summerkills <- df.historical %>%
  filter(month %in% c('6', '7', '8', '9')) %>%
  dplyr::mutate(fishkill = ifelse(anthropogenic == 1 | infectious == 1 | summerkill == 1 | winterkill == 1 | unknown == 1, 1, 0)) %>%
  dplyr::mutate(fishkill_cause = ifelse(anthropogenic == 1, "Anthropogenic",
                                        ifelse(infectious == 1, "Infectious",
                                               ifelse(summerkill == 1, "Summerkill",
                                                      ifelse(winterkill == 1, "Winterkill",
                                                             ifelse(unknown == 1, "Unknown", "")))))) %>%
  dplyr::mutate(fishkill       = as.factor(fishkill),
                fishkill_cause = as.factor(fishkill_cause)) %>%
  subset(., fishkill_cause == "Summerkill" | fishkill_cause == "Summer non-event")

# Create boxplot for mean_surf_z
ggplot() +
  geom_boxplot(data = summerkills, aes(x = fishkill_cause, y = mean_surf_z), outlier.alpha = 1)

# Create boxplot for mean_air
ggplot() +
  geom_boxplot(data = summerkills, aes(x = fishkill_cause, y = mean_air), outlier.alpha = 1)

##########################

# Create winterkills dataframe
winterkills <- df.historical %>%
  filter(month %in% c('12', '1', '2', '3')) %>%
  dplyr::mutate(fishkill = ifelse(anthropogenic == 1 | infectious == 1 | summerkill == 1 | winterkill == 1 | unknown == 1, 1, 0)) %>%
  dplyr::mutate(fishkill_cause = ifelse(anthropogenic == 1, "Anthropogenic",
                                        ifelse(infectious == 1, "Infectious",
                                               ifelse(summerkill == 1, "Summerkill",
                                                      ifelse(winterkill == 1, "Winterkill",
                                                             ifelse(unknown == 1, "Unknown", "Winter non-event")))))) %>%
  dplyr::mutate(fishkill       = as.factor(fishkill),
                fishkill_cause = as.factor(fishkill_cause)) %>%
  subset(., fishkill_cause == "Winterkill" | fishkill_cause == "Winter non-event")


# Create boxplot for mean_surf_z
ggplot() +
  geom_boxplot(data = winterkills, aes(x = fishkill_cause, y = mean_surf_z), outlier.alpha = 1)

# Create boxplot for mean_air
ggplot() +
  geom_boxplot(data = winterkills, aes(x = fishkill_cause, y = mean_air), outlier.alpha = 1)







fig1a_data <- historical_data %>%
  mutate(cause.category.4 = as.factor(replace(as.character(cause.category.4), which(is.na(cause.category.4)), 'Summer Non-event')),
         cause.category.4 = fct_recode(cause.category.4,
                                       "Infectious Agent" = "infectious agent",
                                       "Summerkill"       = "summerkill"))

fig1a_data$sig <- factor(ifelse(fig1a_data$cause.category.4 == 'Summerkill', 'p<.05', 'p>.05'),levels = c('p>.05', 'p<.05'))

boxplot_a <- fig1a_data %>%
  filter(month %in% c("jul", "jun", "aug", "sep")) %>%
  filter(cause.category.4 %in% c('Infectious Agent', "Summerkill", "Summer Non-event")) %>%   
  ggplot(aes(y = mean_surf, x = cause.category.4)) +
  theme_tufte() +  
  ylab('Mean Surf. Temp. (Â°C)') +
  theme(text = element_text(size=13),
        axis.text = element_text(size=13),
        legend.justification = c(1, -0.4), 
        legend.position = c(0.4, 0),
        legend.box.margin=margin(c(50,50,50,50)),
        axis.line = element_line(colour = "black", 
                                 size = 0.5, linetype = "solid"),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  xlab(NULL) +
  geom_boxplot(outlier.alpha = 0.1, aes(fill = sig)) + 
  ggtitle('a') +
  theme(text = element_text(family = 'sans'))+
  scale_fill_manual(values = c('grey', 'gold'), guide = guide_legend(title = NULL))

boxplot_c <- fig1a_data %>%
  filter(month == 'jul' | month == 'jun' | month == 'aug' | month == 'sep') %>%
  filter(cause.category.4 == 'Summerkill' | cause.category.4 == 'Infectious Agent' | cause.category.4 == 'Summer Non-event') %>%   
  ggplot(aes(y = mean_surf_z,x = cause.category.4)) +
  theme_tufte() +
  ylab('Z-score Mean Surf. Temp') +
  guides(fill = FALSE) +
  theme(text = element_text(size = 13, family = 'sans'), 
        axis.text = element_text(size = 11),
        axis.line = element_line(colour = "black", 
                                 size = 0.5, linetype = "solid")) +
  geom_boxplot(outlier.alpha = 0.1, aes(fill = sig)) +
  xlab(NULL) +
  geom_hline(yintercept = 0, alpha = 0.5) + 
  ggtitle('c') +
  scale_fill_manual(values = c('grey', 'gold'), guide = guide_legend(title = 'T-test'))




# Winter

fig1b_data <- historical_data %>%
  mutate(cause.category.4 = replace(as.character(cause.category.4), which(is.na(cause.category.4)), 'Winter Non-event'),
         cause.category.4 = fct_recode(cause.category.4,
                                       "Winterkill" = "winterkill"))


fig1b_data$sig <- ifelse(fig1b_data$cause.category.4 == 'Winterkill', 'p<.05', 'p>.05')
fig1b_data$sig <- factor(fig1b_data$sig, levels = c('p>.05', 'p<.05'))


boxplot_b <- fig1b_data%>%
  filter(month == 'dec' | month == 'jan' | month == 'feb' | month == 'mar') %>%
  filter(cause.category.4 == 'Winterkill' | cause.category.4 == 'Winter Non-event') %>%
  ggplot(aes(y = mean_surf,x = cause.category.4)) +
  theme_tufte() +
  ylab(NULL)+
  xlab(NULL)+
  theme(text = element_text(size=13), 
        axis.text = element_text(size = 13),
        axis.line = element_line(colour = "black", 
                   size = 0.5, linetype = "solid"), 
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  geom_boxplot(outlier.alpha = 0.1, aes(fill = sig))+ 
  guides(fill = FALSE)+ 
  ggtitle('b') +
  theme(text = element_text(family = 'sans'))+
  scale_fill_manual(values = c('grey', 'grey'))

boxplot_d <- fig1b_data %>%
  filter(month == 'dec' | month == 'jan' | month == 'feb' | month == 'mar') %>%
  filter(cause.category.4 == 'Winterkill' | cause.category.4 == 'Winter Non-event') %>%   
  ggplot(aes(y = mean_surf_z,x = cause.category.4)) +
  theme_tufte() +
  xlab('Category of Killtype')+
  geom_boxplot(outlier.alpha = 0.1, aes(fill = sig)) +
  theme(text = element_text(size=13),
        axis.text = element_text(size = 11),
        axis.line = element_line(colour = "black", 
                   size = 0.5, linetype = "solid"))+
  xlab(NULL) +
  ylab(NULL)+
  ylim(-2.5,2) +
  geom_hline(yintercept = 0, alpha = 0.5)+
  scale_fill_brewer()+ 
  guides(fill = FALSE)+ 
  ggtitle('d') +
  theme(text = element_text(family = 'sans'))+
  scale_fill_manual(values = c('grey', 'grey'))


xbox <- grid.arrange(boxplot_a, boxplot_b,ncol = 2, widths = c(6, 3.6))
ybox <- grid.arrange(boxplot_c, boxplot_d, ncol = 2, widths = c(6, 3.6))

p <- grid.arrange(xbox, ybox)
ggsave("figures/boxplot_mean_surf_temp.png", p, width = 8, height = 5, dpi = 300)


























## ANOVA or GLM or something before Dunnett's tests
# one-way anova or 

# Boxplot
ggboxplot(summerkills, x = "summerkill", y = "max_surf")

# Linear model
model.sum.w.max <- lm(max_surf ~ summerkill, data = summerkills)

# Linear model
model.all <- lm(summerkill ~ lat + long + season + population + state + l3_code +
  max_bot + mean_bot + max_surf + mean_surf +
  max_bot_z + mean_bot_z + max_surf_z + mean_surf_z +
  layer_diff + water_quad_temp + peak_temp + ice_duration +
  cumulative_above_0 + cumulative_above_5 + cumulative_above_10, data = df.historical)

summary(model.all)

# QQ plot
ggqqplot(residuals(model.sum.w.max))

# Shapiro Wilk's test
#shapiro_test(residuals(model.sum.w.max)) # normal if insignficant

# Kolmogorov-Smirnov test 
ks.test(x = df.historical$summerkill, y =df.historical$max_surf, alternative = "two.sided")


# Plot
plot(model.sum.w.max, 1)

# Levene's test
PlantGrowth %>% levene_test(summerkill ~ group)




summerkill ~ mean_surf_z
summerkill ~ mean_surf
summerkill ~ max_surf_z
summerkill ~ max_surf

fishkill ~ temp ~ season

# two-way anova
# Figure 1 from Till
#fig1ab.data <- df.historical %>% 
#  filter(month %in% c('6', '7', '8', '9')) %>%
#  mutate(cause.category.4 = replace(as.character(cause.category.4), #which(is.na(cause.category.4)), 'Summer Non-event')) %>%
#  mutate(infectious = ifelse(cause.category.4 == 'infectious', 1, 0))%>% 
#  mutate(summerkill = ifelse(cause.category.4 == 'summerkill', 1, 0))

# Dunnett's test to compare the means of various kill categories against the mean of non-kill lakes

# Create summerkills datafram
summerkills <- df.historical %>%
  filter(month %in% c('6', '7', '8', '9')) %>%
  dplyr::mutate(fishkill = ifelse(anthropogenic == 1 | infectious == 1 | summerkill == 1 | winterkill == 1 | unknown == 1, 0, 1)) %>%
  dplyr::mutate(fishkill_cause = ifelse(anthropogenic == 1, "anthropogenic",
                                        ifelse(infectious == 1, "infectious",
                                               ifelse(summerkill == 1, "infectious",
                                                      ifelse(winterkill == 1, "winterkill",
                                                             ifelse(unknown == 1, "unknown", "none")))))) %>%
  dplyr::mutate(fishkill       = as.factor(fishkill),
                fishkill_cause = as.factor(fishkill_cause))

# Linear model for summerkills
summerkill.lm <- lm(mean_surf_z ~ summerkill, data = summerkills)
summary(summerkill.lm)

# Linear model for all fishkills in summer
fishkill.lm <- lm(mean_surf_z ~ fishkill_cause, data = summerkills)
summary(fishkill.lm)

# Extract residuals from model
fishkill.lm.resid <- residuals(fishkill.lm)
fishkill.lm.fits  <- fitted(fishkill.lm)
# Bind residuals and fits with ass.data
fishkill.resids      <- cbind(summerkills, fishkill.lm.resid)
fishkill.resids.fits <- cbind(fishkill.resids, fishkill.lm.fits)
# Plot residuals vs. fits (not too bad)
plot(fishkill.lm.resid ~ fishkill.lm.fits)

### Normality checks
# Histogram of residuals
fishkill.hist <- hist(fishkill.resids.fits$fishkill.lm.resid)
fishkill.hist
# Normal histogram of residuals
fishkill.norm.hist <- plotNormalHistogram(fishkill.resids.fits$fishkill.lm.resid)
fishkill.norm.hist
# Quantile-quantile (Q-Q) plot
fishkill.qqplot <- qqPlot(fishkill.resids.fits$fishkill.lm.resid, ylab = "fishkill.resid")
fishkill.qqplot
# Shapiro-Wilk test
fishkill.shapiro <- shapiro.test(fishkill.resids.fits$fishkill.lm.resid)
fishkill.shapiro

## Homogeneity of variances
# Treatment level
plot(fishkill.resids.fits$fishkill.lm.resid ~ fishkill.resids.fits$Treatment)
leveneTest(fishkill.resids.fits$fishkill.lm.resid ~ fishkill.resids.fits$Treatment)
# Lake level
plot(fishkill.resids.fits$fishkill.lm.resid~ fishkill.resids.fits$Lake)
leveneTest(fishkill.resids.fits$fishkill.lm.resid ~ fishkill.resids.fits$Lake)
# Monte Carlo (MC) procedure for treatment
lsmeans(fishkill.lm, pairwise ~ Treatment, adjust = "tukey")
# Monte Carlo (MC) procedure for lake (similar to ANOVA results)
lsmeans(fishkill.lm, pairwise ~ Lake, adjust = "tukey")
# Tukey HSD
fishkill.aov <- aov(fishkill.lm)
TukeyHSD(x = fishkill.aov)





model <- aov(mean_surf_z ~ fishkill_cause, data = summerkills)


DunnettTest(mean_surf_z ~ fishkill, data = summerkills, control = summerkills$fishkill)


model <- aov(score ~ technique, data = data)


# Normal distribution plot of mean surface temperature for non-kill events
control.data <- fig1ab.data %>% 
  filter(cause.category.4 == 'Summer Non-event')
qqnorm(control.data$mean_surf)

# Normal distribution plot of mean surface temperature for summerkill events
summerkill.data = fig1ab_data %>% filter(cause.category.4 == 'summerkill')
qqnorm(summerkill.data$mean_surf)

# Normal distribution plot for mean surface temperature  for infectious events
inf.data <- fig1ab.data %>%
  filter(cause.category.4 == 'infectious agent')
qqnorm(inf.data$mean_surf)

# Welch's t-test as opposed to a student's t-test to control for the uneven variance between sample groups when comparing event to non-event lakes directly 
ttest.1a  <- t.test(mean_surf_z ~ summerkill, data = fig1ab.data)
ttest.1a

# Normal distribution plot for z-score of mean surface temperature for summerkill events
summerkill.data <- fig1ab.data %>% filter(cause.category.4 == 'summerkill')
control.data    <- fig1ab.data %>% filter(cause.category.4 == 'Summer Non-event')
qqplot(x = control.data$mean_surf_z, y = summerkill.data$mean_surf_z)
rm(summerkill.data)

# Welch's t-test for z-score of mean surface temperature for infectious events
ttest_1b <- t.test(mean_surf_z ~ infectious, data = fig1ab_data)
ttest_1b

# Normal distribution plot of z-score of mean surface temperature for infectious and non-kill events
inf_data     <- fig1ab.data %>% filter(cause.category.4 == 'infectious agent')
control_data <- fig1ab.data %>% filter(cause.category.4 == 'Summer Non-event')
qqplot(x = control.data$mean_surf_z, y = inf.data$mean_surf_z)
rm(inf.data, control_data)
```

### Step 3: Winterkill statistics

We run an ANOVA to compare the difference in mean temperature for winterkill vs non-event lakes

```{r: Winterkill statistics}
# Anova for differences in mean surface temperature and non-kill events
fig1bd.data <- df.historical %>%
  filter(month %in% c('12', '1', '2')) %>%
  mutate(cause.category.4 = replace(as.character(cause.category.4), which(is.na(cause.category.4)), 'Winter Non-event')) %>% 
  mutate(winterkill = ifelse(cause.category.4 == 'winterkill', 1, 0))

# Anova
anova.data <- fig1bd.data  %>% 
  filter(cause.category.4 == 'Winter Non-event'| cause.category.4 == 'winterkill')
anova <- aov(mean_surf ~ factor(cause.category.4), anova.data)
summary(anova)
#tuk <- TukeyHSD(anova)
#tuk

# Normal distribution plot of mean surface tempertaure for non-kill events
control.data <- fig1bd_data %>%
  filter(cause.category.4 == 'Winter Non-event')
qqnorm(control.data$mean_surf)

# Normal distribution plot of mean surface temperature for winterkill events
winterkill.data <- fig1bd.data %>% 
  filter(cause.category.4 == 'winterkill')
qqnorm(winterkill.data$mean_surf)

# Normal distribution plot of mean surface temperature for winterkill vs non-kill events
qqplot(control.data$mean_surf, winterkill.data$mean_surf)

# Welch's t-test rather an a student due to unequal sizes between the two populations
ttest.1d <- t.test(mean_surf_z ~ winterkill, data = fig1bd.data)
ttest.1d

# Normal distribution plot of z-score for mean surface temperature for winterkill vs non-kill events
qqplot(control.data$mean_surf_z, winterkill.data$mean_surf_z)
rm(control.data, winterkill.data)

# Anova for winterkill events and snow data
fig.SI3.data <- df.historical %>%   
  filter(month %in% c('12', '1', '2'))  %>%
  mutate(lat_round = round(lat, 1), long_round = round(long, 1)) %>%
  inner_join(df.snow, by = c('year', 'month', 'lat_round', 'long_round')) %>%
  mutate(winterkill = ifelse(!is.na(cause.category.4) & cause.category.4 == 'winterkill', 1, 0))

anova.snow <- aov(Snow ~ factor(winterkill), fig.SI3.data)
summary(anova.snow)
#tuk <- TukeyHSD(anova_snow)
#tuk

# Normal distribution plot for snow data and winterkill vs non-kill events
control.data <- fig.SI3.data %>%
  filter(winterkill == 0)
winterkill.data <- fig.SI3.data %>% 
  filter(winterkill == 1)

qqplot(control.data$Snow, winterkill.data$Snow)
rm(control.data, winterkill.data)

# One sample t-test to see if the mean z-score of mean surface temperature is different from zero across seasons
ttest.data.z <- filter(df.historical, cause.category.4 == 'winterkill')
t.test(ttest.data.z$mean_surf_z, mu = 0)

# Anova for winterkill events and ice duration
fig.SI4.data <- df.historical  %>%
  mutate(winterkill = ifelse(!is.na(cause.category.4) & 
                               cause.category.4 == 'winterkill', 1, 0)) %>%
  group_by(year, wbic) %>%
  summarise(ice_duration = mean(ice_duration), winterkill = max(winterkill))

anova <- aov(ice_duration ~ winterkill, fig_SI4_data)
summary(anova)
#tuk <- TukeyHSD(anova)
#tuk

# Normal distribution plot ice_duration for winterkill vs non event}
control.data <- fig_SI4_data %>% filter(winterkill == 0)
winterkill.data <- fig_SI4_data %>% filter(winterkill == 1)
qqplot(control.data$ice_duration, winterkill.data$ice_duration)
rm(control.data, winterkill.data)
```


### Step 4: Moran tests

```{r}
fig3a_data <-historical_data %>%
  mutate(summerkill_binary = ifelse(is.na(summerkill) | summerkill == 'neg', 0 , 1)) %>%
  group_by(wbic) %>%
  summarise(MME = max(summerkill_binary), V1 = mean(lon), V2 = mean(lat))

fig3b_data <- future_data %>%
  dplyr::select(wbic, lat, lon, year) %>%
  bind_cols(predictions_1) %>%
  mutate(event = pos) %>%
  mutate(no_event_prob = 1 - event) %>%
  filter(year > 2030 & year < 2070) %>%
  group_by(wbic) %>%
  summarise(prob = (1 - prod(no_event_prob)), V1 = mean(lon), V2 = mean(lat)) 

fig3c_data <- future_data %>%
  dplyr::select(wbic, lat, lon, year) %>%
  bind_cols(predictions_1)%>%
  mutate(event = pos) %>%
  mutate(no_event_prob = 1 - event) %>%
  filter(year > 2070) %>%
  group_by(wbic) %>%
  summarise(prob = (1 - prod(no_event_prob)), V1 = mean(lon), V2 = mean(lat)) 

coordinates(fig3a_data) <- c('V1', 'V2')
coordinates(fig3b_data) <- c('V1', 'V2')
coordinates(fig3c_data) <- c('V1', 'V2')

nb_p1 <- knn2nb(knearneigh(coordinates(coordinates(fig3a_data)),longlat = TRUE, k = 2))
nb_p2 <- knn2nb(knearneigh(coordinates(coordinates(fig3b_data)),longlat = TRUE, k = 2))
nb_p3 <- knn2nb(knearneigh(coordinates(coordinates(fig3c_data)),longlat = TRUE, k = 2))

weights_p1 <- nb2listw(nb_p1)
weights_p2 <- nb2listw(nb_p2)
weights_p3 <- nb2listw(nb_p3)

moran_MME   <- moran.test(fig3a_data$MME, weights_p1)
moran_Prob2 <- moran.test(fig3b_data$prob, weights_p2)
moran_Prob3 <- moran.test(fig3c_data$prob, weights_p3)

moran_MME
moran_Prob2
moran_Prob3
```

######################################
The End
######################################
